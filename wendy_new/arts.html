<!DOCTYPE html>
<html>
<head>
<title>arts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/arts.css">
<!-- <link href="js/videojs/video-js.min.css" rel="stylesheet" type="text/css"> -->
<link href="css/video-js.min.css" rel="stylesheet" type="text/css">
</head>
<body>

<div id="content" class="content">

</div>

</body>

<!-- <script type="text/javascript" src="js/videojs/video.js"></script> -->
<script type="text/javascript" src="js/video.min.js"></script>
<script src="js/build/react.js"></script>
<script src="js/build/react-dom.js"></script>
<script src="js/build/browser.min.js"></script>
<script src="js/build/jquery.min.js"></script>
<script src="js/signals.min.js"></script>

<script src="js/utils.js"></script>
<script src="js/constant.js"></script>

<script>
  //videojs.options.flash.swf = "http://example.com/path/to/video-js.swf"
</script>
<!--<script type="text/babel" src="js/artCollection.js"></script>-->
<script type="text/babel">
	var  debug = true;
	var broadData = new signals.Signal(); //全局数据广播对象

	var BigCanvas = React.createClass({
		
		getInitialState: function() {
			return {
				data: this.props.data,
				id: this.props.id
			};
		},

		componentDidMount: function() {
			var self = this;
			console.log("BigCanvas componentDidMount");

			self.createVideoView(self.state.id);
			
			broadData.add(function(val){ 	// 收听到数据
				if(self.myPlayer != null) {
					self.myPlayer.dispose();
					self.myPlayer = null;
				}
				// $(self).delay(1000).queue(function() {
				console.log('setState id:' + val);
				self.setState({id: val});
				// 	$(self).dequeue();
				// });
            });
		},

		componentDidUpdate: function() {
			var self = this;
			var el = $("#video_id");
			console.log('componentDidUpdate id:' + self.state.id);
			self.createVideoView(self.state.id);
		},

		createVideoView: function(val) {
			var currData = this.state.data.urls[val];
			if(currData.type == constant.View_Type_Movie) {
				var url = currData.url;
				if(debug){
					url = "file:///C:/Users/zuffy.ma.SUPERD/Desktop/" + url;
				}
				this.createVideoIfnull(url)
			}
		},

		createVideoIfnull: function(url) {
			var self = this;

			$("#videoContent").html("<video id='video_id' class='video-js vjs-default-skin' controls preload='none' height='578' data-setup='{}'></video>");

			videojs('video_id', {}, function() {
				self.myPlayer = this;
				self.myPlayer.src({ type: "video/mp4", src: url });
				console.log('set play url ad play: ' + self.myPlayer);
				self.myPlayer.play();
			});
		},

		render: function() {
			var vi;
			var self = this;
			console.log('render type:' + this.props.data.urls[this.state.id].type + " id:" + this.state.id);
			
			if(this.props.data.urls[this.state.id].type == constant.View_Type_Movie){
				
				vi = <div id="videoContent"></div>

				console.log('================== render video content ==================')
			} else {
				var url = this.props.data.urls[this.state.id].url;
				vi = <img className='imageshow' src={url}/>
			}
			
			return (
				vi
			);
		}
	});


	var ScreenShoots = React.createClass({

		handleChange: function(index) {
			// console.log('index:' + index);
			this.setState({'current': index});
			broadData.dispatch(index); //发布数据
		},
		
		getInitialState: function() {
			return {
				current: this.props.id
			};
		},

		componentDidMount: function() {
			console.log("ScreenShoots did mount!");
		},

		render: function() {
			var self = this;
			//console.log(this.props.data["urls"]);
			return (
				<ol className='navBar'>
				{
					self.props.data["urls"].map(function (item, i) {
						if(typeof(item.snapsrc) == "string" && item.snapsrc.length > 0){
						var cc = 'snapIcon'
						cc += self.state.current == i ? ' current' : '';
						
						return <li 
							className={cc}
							key={i} onClick={self.handleChange.bind(null, i)}>
							<img src={item.snapsrc} />
							<p>{item.title}</p>
							</li>;
						}
					})
				}
				</ol>
			);
		}
	});


	var CornerPlace = React.createClass({
		
		getInitialState: function() {
			return {
			};
		},

		componentDidMount: function() {
			// console.log("CornerPlace did mount!");
		},

		render: function() {
			var self = this;
			console.log(self.props.data);
			return (
				<div className="awards"> 
					<p className='awardsTitle'>{this.props.data.desc} </p>
					<ol className='awardsList'>
					{
						self.props.data["urls"].map(function (item, i) {
							return <li className='awardsItem' key={i}>
								<img src={item.url} height='45'/>
								</li>;
						})
					}
					</ol>
				</div>
			);
		}
	});


	var Description = React.createClass({
		
		getInitialState: function() {
			return {
			};
		},

		componentDidMount: function() {
			// console.log("Description did mount!");
		},

		render: function() {
			return (
				<div className='clear desContainer'>
					<p className='title'>{this.props.title}</p>
					<p className='desc' dangerouslySetInnerHTML={{__html:this.props.desc}}></p>
				</div>
			);
		}
	});


	var ArtShowView = React.createClass({
		
		getInitialState: function() {
			return {
				data: constant.data[this.props.name],
				name: this.props.name,
				id: this.props.id
			};
		},

		setIndex: function(val) {
			// console.log("set index val:" + val);
			// this.setState({'id': val});
		},

		componentDidMount: function() {
			var self = this;
			console.log("ArtShowView did mount!");
			broadData.add(function(val){ //收听到数据
               // self.setState({'id': val});
            });
		},

		render: function() {
			console.log("render ArtShowView :" + this.state.id);
			var awards = this.state.data['awards'];
			//console.log(awards)
			return (
				<div className='mainContainer'>
					<BigCanvas data={this.state.data} id={this.state.id}/>
					<ScreenShoots data={this.state.data} id={this.state.id}/>
					<CornerPlace data={awards}/>
					<Description title={this.state.data['descTitle']} desc={this.state.data['desc']}/>
				</div>
			);
		}
	});

	
	var App = React.createClass({
		getInitialState: function() {
			var name = utils.paramAtPath("name") || "default";
			var id = utils.paramAtPath("id") || 0;
			return {
				name: name,
				id: id
			};
		},

		componentDidMount: function() {
			console.log("App did mount!");
		},

		render: function() {
			return (
				<ArtShowView name={this.state.name} id={this.state.id}/>
			);
		}
	});

	ReactDOM.render(
		<App />,
		document.getElementById('content')
	);

</script>

</html>